<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Solar Forecast Graph</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; }
    #chart { width: 100%; height: 85vh; }
    .meta { color: #555; margin-bottom: 8px; }
  </style>
</head>
<body>
  <h2 id="title">Solar Power Forecast</h2>
  <div class="meta" id="meta">Waiting for dataâ€¦</div>
  <div id="chart"></div>

<script>
async function fetchLatest() {
  const res = await fetch("/latest", { cache: "no-store" });
  return await res.json();
}

function draw(data) {
  document.getElementById("title").textContent = data.title || "Solar Power Forecast";
  document.getElementById("meta").textContent =
    data.updated_at ? `Last update: ${data.updated_at}` : "No updates yet";

  const traceHist = {
    x: data.t_hist,
    y: data.y_hist,
    name: "Actual (History)",
    mode: "lines+markers"
  };

  const tracePred = {
    x: data.t_pred,
    y: data.y_pred,
    name: "Predicted",
    mode: "lines+markers"
  };

  const layout = {
    xaxis: { title: "Time" },
    yaxis: { title: "Power (kW)" },
    margin: { l: 60, r: 20, t: 20, b: 60 },
    legend: { orientation: "h" }
  };

  Plotly.react("chart", [traceHist, tracePred], layout, { responsive: true });
}

async function loop() {
  try {
    const data = await fetchLatest();
    draw(data);
  } catch (e) {
    document.getElementById("meta").textContent = "Error fetching data.";
  }
}

loop();
setInterval(loop, 2000);
</script>
</body>
</html>
